<%- include('../partials/header.ejs') %>
<style>
    label {
        margin-bottom: 0px !important;
    }
    input[type='text'] {
        padding: 0px 12px;
    }
</style>
<div class="content-wrapper">
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0 text-dark">Criar filas de Mensagens</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="#">Home</a></li>
                        <li class="breadcrumb-item active">Filas de Mensagens</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
    <section class="content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Selecionar Dados</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="empresa">Empresa</label>
                                <select name="empresa" id="empresa" class="form-control form-control-border border-width-2" onchange="updateApoiadores()">
                                    <option value="">Selecione</option>
                                    <% empresa.forEach(empresa => { %>
                                    <option value="<%=empresa.id %>"><%=empresa.nome %></option>
                                    <% }) %>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="tipoApoiador">Tipo Apoiador</label>
                                <select name="tipoApoiador" id="tipoApoiador" class="form-control form-control-border border-width-2" onchange="updateApoiadores()">
                                    <option value="">Selecione</option>
                                    <% tipo.forEach(tipo => { %>
                                    <option value="<%=tipo.id %>"><%=tipo.descricao %></option>
                                    <% }) %>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="apoiador">Apoiador</label>
                                <select name="apoiador" id="apoiador" class="form-control form-control-border border-width-2" onchange="loadContacts()">
                                    <option value="">Selecione</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="mensagem">Template de Mensagem</label>
                                <select name="mensagem" id="mensagem" class="form-control form-control-border border-width-2" onchange="loadMessageTemplate()">
                                    <option value="">Selecione</option>
                                    <% mensagem.forEach(mensagem => { %>
                                    <option value="<%=mensagem.id %>"><%=mensagem.titulo %></option>
                                    <% }) %>
                                </select>
                            </div>
                            <div class="form-group">
                                <div class="card">
                                    <div class="card-header">
                                        <h3 class="card-title">
                                            <i class="fas fa-text-width"></i>
                                            Mensagem
                                        </h3>
                                    </div>
                                    <div class="card-body">
                                        <dl>
                                            <dd id="displayMsg"></dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="timer">Tempo entre disparos</label>
                                <select name="timer" id="timer" class="form-control form-control-border border-width-2">
                                    <option value="">Selecione</option>
                                    <option value="5000">5 Segundos</option>
                                    <option value="10000">10 Segundos</option>
                                    <option value="15000">15 Segundos</option>
                                    <option value="20000">20 Segundos</option>
                                    <option value="30000">30 Segundos</option>
                                    <option value="45000">45 Segundos</option>
                                    <option value="60000">1 minuto</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-footer clearfix">
                            <button id="btnStart" class="btn btn-primary" onclick="startDisparos()">Enviar</button>
                            <br/><br/>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Lista de Contatos</h3>
                        </div>
                        <div class="card-body">
                            <div class="card-body table-responsive ">
                              <table id="contato" class="table table-hover">
                                  <thead>
                                    <tr>
                                      <th>ID</th>
                                      <th>Nome</th>
                                      <th>WhatsApp</th>
                                    </tr>
                                  </thead>
                                <tbody></tbody>
                              </table>
                          </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>
<%- include('../partials/footer.ejs') %>
<script>

    function updateApoiadores() {
        const empresaId = document.getElementById('empresa').value;
        const tipoApoiadorId = document.getElementById('tipoApoiador').value;

        if (empresaId && tipoApoiadorId) {
            $.ajax({
                type: 'POST',
                url: '/disparos/apoiador',
                data: { EmpresaId: empresaId, tipoApoiadorId: tipoApoiadorId },
                dataType: 'json',
                success: (res) => {
                    const apoiadorSelect = $('#apoiador');
                    apoiadorSelect.empty().append('<option value="">Selecione</option>');
                    res.forEach((element) => {
                        apoiadorSelect.append(`<option value="${element.id}">${element.nome}</option>`);
                    });
                },
                error: () => {
                    $('#apoiador').text('Erro ao carregar apoiadores!');
                }
            });
        }
    }

    function loadMessageTemplate() {
        const mensagemId = document.getElementById('mensagem').value;
        if (mensagemId) {
            $.ajax({
                type: 'POST',
                url: '/disparos/mensagens',
                data: { id: mensagemId },
                dataType: 'json',
                success: (res) => {
                    $('#displayMsg').empty().append(res[0].body);
                },
                error: () => {
                    $('#displayMsg').text('Erro ao carregar mensagem!');
                }
            });
        }
    }

    function loadContacts() {
      var table;
      if ($.fn.DataTable.isDataTable("#contato")) {
          $('#contato').DataTable().clear().destroy();
      }
      table = $('#contato').DataTable({
          processing: true,
          serverSide: true,
          ajax: {
              type: 'POST',
              url: '/disparos/contatos',
              data: function (d) {
                  d.ApoiadorId = document.getElementById('apoiador').value;
              }
          },
          columns: [
              { data: 'id' },
              { data: 'nome' },
              { data: 'whatsapp' }
          ]
      });
    }

    function startDisparos() {
        if (!validarFormulario()) {
            return;
        }

        Swal.fire({
            title: 'Enviando Mensagens...',
            html: 'Por favor, aguarde enquanto as mensagens estÃ£o sendo enviadas.',
            allowOutsideClick: false,
            allowEscapeKey: false,
            allowEnterKey: false,
            showConfirmButton: false,
            willOpen: () => {
                Swal.showLoading();
            }
        });

        realizarEnvio();
    }

    function realizarEnvio() {
        $.ajax({
            type: 'POST',
            url: '/disparos/createQueue',
            data: {
                ApoiadorId: $('#apoiador').val(),
                nomeEmpresa: $('#empresa option:selected').text().trim(),
                time: $('#timer').val(),
            },
            dataType: 'json',
            success: () => {
                Swal.fire({
                    icon: 'success',
                    title: 'Sucesso!',
                    text: 'Todas as mensagens foram enfileiradas com sucesso.',
                    confirmButtonText: 'OK'
                }).then(() => {
                    resetarFormulario();
                });
            },
            error: (xhr) => {
                const errorMessage = xhr.status === 404 ? xhr.responseJSON.error : 'Erro desconhecido ao criar fila.';
                Swal.fire('Erro!', errorMessage, 'error');
            }
        });
    }

    function resetarFormulario() {
        $('#empresa').val('');
        $('#tipoApoiador').val('');
        $('#apoiador').empty().append('<option value="">Selecione</option>');
        $('#mensagem').val('');
        $('#timer').val('');
        $('#displayMsg').empty();
        if ($.fn.DataTable.isDataTable("#contato")) {
        $('#contato').DataTable().clear().destroy();
        }
        $('#contato').DataTable();
    }

    function validarFormulario() {
        if (!$('#empresa').val()) {
            Swal.fire('Erro!', 'Selecione uma Empresa para continuar.', 'error');
            return false;
        }
        if (!$('#tipoApoiador').val()) {
            Swal.fire('Erro!', 'Selecione um Tipo de Apoiador para continuar.', 'error');
            return false;
        }
        if (!$('#apoiador').val()) {
            Swal.fire('Erro!', 'Selecione um Apoiador para continuar.', 'error');
            return false;
        }
        if (!$('#mensagem').val()) {
            Swal.fire('Erro!', 'Selecione uma Mensagem para continuar.', 'error');
            return false;
        }
        if (!$('#timer').val()) {
            Swal.fire('Erro!', 'Selecione um timer para continuar.', 'error');
            return false;
        }
        return true;
    }
</script>
